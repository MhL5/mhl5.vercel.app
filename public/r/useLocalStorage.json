{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "useLocalStorage",
  "type": "registry:hook",
  "title": "useLocalStorage",
  "description": "A hook for managing local storage.",
  "registryDependencies": [
    "https://mhl5.vercel.app/r/checks.json"
  ],
  "files": [
    {
      "path": "src/registry/hooks/useLocalStorage/useLocalStorage.ts",
      "content": "\"use no memo\";\r\n\r\nimport { useCallback, useMemo, useRef, useSyncExternalStore } from \"react\";\r\nimport { readStorageJsonValue } from \"@/utils/readStorageJson\";\r\n\r\nexport function useLocalStorage<T>(key: string, defaultValue: T | (() => T)) {\r\n  const defaultVal = useMemo(\r\n    () => (defaultValue instanceof Function ? defaultValue() : defaultValue),\r\n    [defaultValue],\r\n  );\r\n  const snapshotRef = useRef<T | null>(null);\r\n  const snapshotKeyRef = useRef<string | null>(null);\r\n\r\n  const getSnapshot = useCallback(() => {\r\n    const newValue = readStorageJsonValue(key, defaultVal, localStorage);\r\n\r\n    const isSame =\r\n      snapshotKeyRef.current === key &&\r\n      JSON.stringify(snapshotRef.current) === JSON.stringify(newValue);\r\n    // Compare by JSON string to avoid reference inequality issues\r\n    if (isSame) return snapshotRef.current;\r\n\r\n    snapshotRef.current = newValue;\r\n    snapshotKeyRef.current = key;\r\n    return newValue;\r\n  }, [key, defaultVal]);\r\n\r\n  const snapshot: T = useSyncExternalStore(\r\n    (cb) => _subscribe(key, cb),\r\n    getSnapshot,\r\n    () => defaultVal,\r\n  );\r\n  const valueRef = useRef(snapshot);\r\n  valueRef.current = snapshot;\r\n\r\n  const setValue = useCallback(\r\n    (newValue: T | ((prev: T) => T)) => {\r\n      const nextValue =\r\n        newValue instanceof Function ? newValue(valueRef.current) : newValue;\r\n\r\n      if (nextValue === undefined || nextValue === null)\r\n        localStorage.removeItem(key);\r\n      else localStorage.setItem(key, JSON.stringify(nextValue));\r\n\r\n      window.dispatchEvent(\r\n        new StorageEvent(\"storage\", {\r\n          key,\r\n        }),\r\n      );\r\n    },\r\n    [key],\r\n  );\r\n\r\n  const remove = useCallback(() => {\r\n    localStorage.removeItem(key);\r\n    window.dispatchEvent(\r\n      new StorageEvent(\"storage\", {\r\n        key,\r\n      }),\r\n    );\r\n  }, [key]);\r\n\r\n  return [snapshot, setValue, remove] as const;\r\n}\r\n\r\nfunction _subscribe(key: string, callback: () => void) {\r\n  const handler = (e: StorageEvent) => {\r\n    if (e.key === key) callback();\r\n  };\r\n  window.addEventListener(\"storage\", handler);\r\n  return () => window.removeEventListener(\"storage\", handler);\r\n}\r\n",
      "type": "registry:hook"
    },
    {
      "path": "src/utils/readStorageJson.ts",
      "content": "import { isDev } from \"@/registry/utils/checks/checks\";\r\n\r\nconst INVALID_VALUES = [\"\", \"undefined\", \"null\"];\r\n\r\nexport function readStorageJsonValue<T>(\r\n  key: string,\r\n  defaultValue: T | (() => T),\r\n  storageObject: Storage,\r\n) {\r\n  try {\r\n    if (!storageObject) return _handleDefaultValue(defaultValue);\r\n\r\n    const item = storageObject.getItem(key);\r\n\r\n    if (item !== null && item !== undefined && !INVALID_VALUES.includes(item))\r\n      return JSON.parse(item);\r\n\r\n    return _handleDefaultValue(defaultValue);\r\n  } catch (error) {\r\n    if (isDev()) throw error;\r\n\r\n    return _handleDefaultValue(defaultValue);\r\n  }\r\n}\r\n\r\nconst _handleDefaultValue = <T>(defaultValue: T | (() => T)) =>\r\n  defaultValue instanceof Function ? defaultValue() : defaultValue;\r\n",
      "type": "registry:lib",
      "target": "src/utils/readStorageJson.ts"
    }
  ]
}