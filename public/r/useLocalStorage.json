{
  "$schema": "https://ui.shadcn.com/schema/registry-item.json",
  "name": "useLocalStorage",
  "type": "registry:hook",
  "title": "useLocalStorage",
  "description": "A React hook built on top of `useSyncExternalStore` that synchronizes state with `localStorage`, providing reactive updates across browser tabs and windows.",
  "registryDependencies": [
    "https://mhl5.vercel.app/r/checks.json"
  ],
  "files": [
    {
      "path": "src/registry/hooks/useLocalStorage/useLocalStorage.ts",
      "content": "\"use client\";\r\n\r\nimport { useCallback, useMemo, useSyncExternalStore } from \"react\";\r\nimport { isDev } from \"@/registry/utils/checks/checks\";\r\n\r\nconst LOCAL_STORAGE_CHANGE_EVENT = \"local-storage-change\";\r\n\r\nexport function useLocalStorage<T>(key: string, initialValue: T | (() => T)) {\r\n  const getSnapshot = useCallback(() => localStorage.getItem(key), [key]);\r\n  const getServerSnapshot = useCallback(() => null, []);\r\n  const subscribe = useCallback(\r\n    (onChange: () => void) => {\r\n      const abortController = new AbortController();\r\n\r\n      window.addEventListener(\r\n        \"storage\",\r\n        (e) => {\r\n          if (e.key === key) onChange();\r\n        },\r\n        {\r\n          signal: abortController.signal,\r\n        },\r\n      );\r\n      window.addEventListener(\r\n        LOCAL_STORAGE_CHANGE_EVENT,\r\n        (e) => {\r\n          const customEvent = e as CustomEvent;\r\n          if (customEvent.detail.key === key) onChange();\r\n        },\r\n        {\r\n          signal: abortController.signal,\r\n        },\r\n      );\r\n\r\n      return () => abortController.abort();\r\n    },\r\n    [key],\r\n  );\r\n\r\n  /**\r\n   * we cant parse the json here\r\n   * because if the parsed value is an object, it will cause an infinite loop\r\n   * we will only return a string snapshot and parse it after (string is a primitive value)\r\n   */\r\n  const jsonSnapshot = useSyncExternalStore(\r\n    subscribe,\r\n    getSnapshot,\r\n    getServerSnapshot,\r\n  );\r\n\r\n  const parsedSnapshot = useMemo(() => {\r\n    const resolvedInitialValue =\r\n      initialValue instanceof Function ? initialValue() : initialValue;\r\n    try {\r\n      return jsonSnapshot ? JSON.parse(jsonSnapshot) : resolvedInitialValue;\r\n    } catch (error) {\r\n      if (isDev())\r\n        // eslint-disable-next-line no-console\r\n        console.error(`Error parsing value for ${key} in localStorage`, error);\r\n      return resolvedInitialValue;\r\n    }\r\n  }, [jsonSnapshot, initialValue, key]);\r\n\r\n  const setData = useCallback(\r\n    (value: T | ((prev: T) => T)) => {\r\n      const resolvedValue =\r\n        value instanceof Function ? value(parsedSnapshot) : value;\r\n\r\n      const isResolvedValueInvalid =\r\n        resolvedValue === undefined || resolvedValue === null;\r\n\r\n      if (isResolvedValueInvalid) localStorage.removeItem(key);\r\n      else localStorage.setItem(key, JSON.stringify(resolvedValue));\r\n      window.dispatchEvent(\r\n        new CustomEvent(LOCAL_STORAGE_CHANGE_EVENT, { detail: { key } }),\r\n      );\r\n    },\r\n    [key, parsedSnapshot],\r\n  );\r\n\r\n  return useMemo(\r\n    () => [parsedSnapshot, setData] as const,\r\n    [parsedSnapshot, setData],\r\n  );\r\n}\r\n",
      "type": "registry:hook"
    }
  ],
  "meta": {
    "url": "/snippets/hooks/useLocalStorage"
  }
}